---
- name: "92) Docker Bench for Security: 도커 호스트 보안 베스트프랙티스 점검 + HTML 리포트"
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    lab_root: /opt/security-lab
    reports_dir: "{{ lab_root }}/reports"
    bench_image: "docker/docker-bench-security:latest"
    bench_parser: "{{ playbook_dir }}/../files/docker_bench_to_html.py"

    # (선택) 브라우저 없는 서버에서 웹으로 보기
    serve_html: false
    serve_port: 18080

    # Docker Desktop/WSL에서 systemd 마운트가 없어서 실패하는 경우가 많아 기본 off
    mount_systemd: false
    mount_var_lib: true

  pre_tasks:
    # 실제 로그인 사용자/홈(=sudo로 root 되기 전 기준) 확보
    - name: Capture real user/home on control node
      ansible.builtin.set_fact:
        real_user: "{{ lookup('env','SUDO_USER') | default(lookup('env','USER'), true) }}"
        real_home: "{{ lookup('env','HOME') }}"
        real_docker_config: "{{ lookup('env','HOME') }}/.docker"

    - name: Ensure reports directory exists (root)
      become: true
      ansible.builtin.file:
        path: "{{ reports_dir }}"
        state: directory
        mode: "0755"

    - name: Give write permission to real user for reports_dir (so docker tasks can run without become)
      become: true
      ansible.builtin.file:
        path: "{{ reports_dir }}"
        state: directory
        owner: "{{ real_user }}"
        group: "{{ real_user }}"
        mode: "0755"

    - name: Preflight - docker must be reachable for real user
      become: false
      ansible.builtin.command: docker info
      environment:
        DOCKER_CONFIG: "{{ real_docker_config }}"
        HOME: "{{ real_home }}"
      register: docker_info_pre
      changed_when: false
      failed_when: docker_info_pre.rc != 0

    - name: Check optional mount paths
      ansible.builtin.stat:
        path: "{{ item }}"
      register: mount_stats
      loop:
        - /var/run/docker.sock
        - /etc
        - /var/lib
        - /usr/lib/systemd

  tasks:
    - name: Freeze timestamp once
      ansible.builtin.set_fact:
        bench_ts: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

    - name: Set report paths using frozen timestamp
      ansible.builtin.set_fact:
        raw_path: "{{ reports_dir }}/docker-bench-{{ bench_ts }}.raw.txt"
        clean_path: "{{ reports_dir }}/docker-bench-{{ bench_ts }}.txt"
        html_path: "{{ reports_dir }}/docker-bench-{{ bench_ts }}.html"

    - name: Pull Docker Bench image (as real user, using user's docker context)
      become: false
      ansible.builtin.command: "docker pull {{ bench_image }}"
      environment:
        DOCKER_CONFIG: "{{ real_docker_config }}"
        HOME: "{{ real_home }}"
      register: pull_out
      changed_when: >
        ('Downloaded newer image' in pull_out.stdout) or
        ('Pull complete' in pull_out.stdout)

    - name: Build docker run mounts (only existing paths)
      ansible.builtin.set_fact:
        bench_mounts: >-
          {{
            [
              '-v /var/run/docker.sock:/var/run/docker.sock:ro',
              '-v /etc:/etc:ro'
            ]
            + (['-v /var/lib:/var/lib:ro'] if (mount_var_lib and (mount_stats.results | selectattr("item","equalto","/var/lib") | first).stat.exists) else [])
            + (['-v /usr/lib/systemd:/usr/lib/systemd:ro'] if (mount_systemd and (mount_stats.results | selectattr("item","equalto","/usr/lib/systemd") | first).stat.exists) else [])
          }}

    - name: Run Docker Bench (RAW with ANSI colors) - as real user
      become: false
      ansible.builtin.shell: |
        set -euo pipefail
        docker run --rm \
          --net host \
          --pid host \
          --cap-add audit_control \
          {{ bench_mounts | join(' ') }} \
          {{ bench_image }} 2>&1 | tee "{{ raw_path }}"
      args:
        executable: /bin/bash
      environment:
        DOCKER_CONFIG: "{{ real_docker_config }}"
        HOME: "{{ real_home }}"
      changed_when: true

    - name: Stat RAW
      ansible.builtin.stat:
        path: "{{ raw_path }}"
      register: raw_stat

    - name: Fail if RAW is missing
      ansible.builtin.fail:
        msg: "RAW file not created: {{ raw_path }} (docker run failed or permission/path issue)"
      when: not raw_stat.stat.exists

    - name: Strip ANSI color codes -> clean txt
      ansible.builtin.shell: |
        set -euo pipefail
        sed -r 's/\x1B\[[0-9;]*[A-Za-z]//g' "{{ raw_path }}" > "{{ clean_path }}"
      args:
        executable: /bin/bash
      changed_when: true

    - name: Check parser exists
      ansible.builtin.stat:
        path: "{{ bench_parser }}"
      register: parser_stat

    - name: Fail if parser missing
      ansible.builtin.fail:
        msg: "Parser script not found: {{ bench_parser }} (create files/docker_bench_to_html.py)"
      when: not parser_stat.stat.exists

    - name: Generate HTML report from clean txt (python script)
      ansible.builtin.command:
        argv:
          - python3
          - "{{ bench_parser }}"
          - "{{ clean_path }}"
          - "{{ html_path }}"
      changed_when: true

    - name: Print report locations
      ansible.builtin.debug:
        msg:
          - "Docker Bench RAW : {{ raw_path }}"
          - "Docker Bench TXT : {{ clean_path }}"
          - "Docker Bench HTML: {{ html_path }}"
          - "TIP) serve_html=true 로 웹서버 띄우기 가능"

    - name: Start simple http server to view HTML (optional)
      ansible.builtin.shell: |
        set -euo pipefail
        nohup python3 -m http.server {{ serve_port }} --directory "{{ reports_dir }}" >/tmp/docker-bench-http.log 2>&1 &
        echo "http://localhost:{{ serve_port }}/{{ html_path | basename }}"
      args:
        executable: /bin/bash
      changed_when: true
      when: serve_html | bool
